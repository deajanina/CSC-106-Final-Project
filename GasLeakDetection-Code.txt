#include <Wire.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27, 16, 2);

const int MQ2_PIN = A0;
const int BUZZER_PIN = 8;
const int GREEN_LED = 9;   // Green LED pin for normal operation
const int RED_LED = 10;    // Red LED pin for gas detected

// Set this value after observing clean air readings
const int CLEAN_AIR_BASELINE = 300; // Adjust this!
const int GAS_THRESHOLD = 400
;      // Adjust this!

void setup() {
  lcd.init();
  lcd.backlight();
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(GREEN_LED, OUTPUT);
  pinMode(RED_LED, OUTPUT);
  Serial.begin(9600);
  
  // Extended LED test on startup
  lcd.setCursor(0, 0);
  lcd.print("LED Test Running");
  
  // Test RED LED
  lcd.setCursor(0, 1);
  lcd.print("Red LED ON       ");
  digitalWrite(RED_LED, HIGH);
  digitalWrite(GREEN_LED, LOW);
  delay(1000);
  
  // Test GREEN LED  
  lcd.setCursor(0, 1);
  lcd.print("Green LED ON     ");
  digitalWrite(RED_LED, LOW);
  digitalWrite(GREEN_LED, HIGH);
  delay(1000);
  
  // Test BOTH LEDs
  lcd.setCursor(0, 1);
  lcd.print("Both LEDs ON     ");
  digitalWrite(RED_LED, HIGH);
  digitalWrite(GREEN_LED, HIGH);
  delay(1000);
  
  // All OFF
  lcd.setCursor(0, 1);
  lcd.print("All LEDs OFF     ");
  digitalWrite(RED_LED, LOW);
  digitalWrite(GREEN_LED, LOW);
  delay(500);
  
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Gas Detector Ready");
  lcd.setCursor(0, 1);
  lcd.print("System Running...");
  delay(2000);
  lcd.clear();
  
  // Start with green LED on (normal state)
  digitalWrite(GREEN_LED, HIGH);
}

void loop() {
  int rawValue = analogRead(MQ2_PIN);
  int gasLevel = rawValue - CLEAN_AIR_BASELINE;
  
  // Ensure gasLevel doesn't go negative
  if (gasLevel < 0) gasLevel = 0;
  
  Serial.print("Raw: ");
  Serial.print(rawValue);
  Serial.print(" | Gas Level: ");
  Serial.print(gasLevel);
  Serial.print(" | Red LED: ");
  Serial.print(digitalRead(RED_LED));
  Serial.print(" | Green LED: ");
  Serial.println(digitalRead(GREEN_LED));
  
  if (gasLevel > GAS_THRESHOLD) {
    lcd.setCursor(0, 0);
    lcd.print("GAS DETECTED!    ");
    lcd.setCursor(0, 1);
    lcd.print("Level: ");
    lcd.print(gasLevel);
    lcd.print("    ");
    
    // RED LED ON, Green LED OFF during gas detection
    digitalWrite(RED_LED, HIGH);
    digitalWrite(GREEN_LED, LOW);
    
    // Buzzer beeping
    digitalWrite(BUZZER_PIN, HIGH);
    delay(500);
    digitalWrite(BUZZER_PIN, LOW);
    delay(500);
    
  } else {
    lcd.setCursor(0, 0);
    lcd.print("Scanning...      ");
    lcd.setCursor(0, 1);
    lcd.print("Safe: ");
    lcd.print(gasLevel);
    lcd.print("     ");
    
    // GREEN LED ON, Red LED OFF during normal operation
    digitalWrite(GREEN_LED, HIGH);
    digitalWrite(RED_LED, LOW);
    
    // Buzzer off
    digitalWrite(BUZZER_PIN, LOW);
  }
  
  delay(100);
}